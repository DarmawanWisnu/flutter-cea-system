@startuml
scale 3240*1710
skinparam monochrome true
skinparam ranksep 50
skinparam nodesep 30
title Class Diagram - Arsitektur Sistem Flutter CEA System

' =================== UI LAYER ===================
package "UI Layer" {
  class AuthGate
  class SplashScreen
  class HomeScreen
  class MonitorScreen
  class HistoryScreen
  class NotificationScreen
  class AddKitScreen
  class SettingsScreen
  class ProfileScreen
}

' =================== PROVIDER LAYER ===================
package "Providers" {
  class MqttVM {
    - _svc : MqttService
    - _autoModeDevices : Set<String>
    + telemetryMap : Map<String, Telemetry>
    + statusMap : Map<String, DeviceStatus>
    + init()
    + publishActuator()
    + enableAutoMode()
    + disableAutoMode()
    + isAutoMode()
    + loadAutoModeFromBackend()
  }

  class NotificationListNotifier {
    - _ref : Ref
    + fetchNotifications()
    + markRead()
    + markAllRead()
    + delete()
    + clearAll()
  }

  class MonitorTelemetryProvider {
    + data : Telemetry
    + lastUpdated : DateTime
  }

  class ApiProvider {
    + kits : List<Kit>
    + fetchKits()
    + addKit()
    + deleteKit()
  }

  class AuthProvider {
    + user : User?
    + isLoading : bool
  }

  class UrlSettingsProvider {
    + baseUrl : String
    + updateBaseUrl()
  }
}

' =================== SERVICE LAYER ===================
package "Services" {
  class AuthService {
    - _auth : FirebaseAuth
    + signInWithEmailPassword()
    + registerWithEmailPassword()
    + signOut()
    + sendEmailVerification()
    + sendPasswordReset()
    + reloadUser()
  }

  class MqttService {
    - _client : MqttServerClient
    + connectionState$ : Stream
    + telemetry$ : Stream
    + status$ : Stream
    + connect()
    + publishControl()
    + disconnect()
  }

  class ApiService {
    - baseUrl : String
    + getLatestTelemetry()
    + getTelemetryHistory()
    + getLatestActuatorEvent()
    + setDeviceMode()
    + getDeviceMode()
    + getNotifications()
    + markNotificationRead()
    + deleteNotification()
  }

  class ApiKitsService {
    + getKits()
    + addKit()
    + deleteKit()
  }
}

' =================== MODEL LAYER ===================
package "Models" {
  class Telemetry {
    + id : int?
    + ingestTime : int?
    + ppm : double
    + ph : double
    + tempC : double
    + humidity : double
    + waterTemp : double
    + waterLevel : double
    + fromJson()
    + toJson()
    + copyWith()
  }

  class DeviceStatus {
    + online : bool
    + lastSeen : DateTime
  }

  class Kit {
    + id : String
    + name : String
    + createdAt : DateTime
  }

  class NotificationItem {
    + id : String
    + kitId : String
    + level : String
    + message : String
    + timestamp : DateTime
    + isRead : bool
  }

  class HistoryRouteArgs {
    + targetTime : DateTime?
    + kitName : String?
    + kitId : String?
    + reason : String?
  }

  class NotificationRouteArgs {
    + initialFilter : String?
  }
}

' =================== CORE LAYER ===================
package "Core" {
  class AppConst {
    + defaultKitId : String
    + formatDateTime()
  }

  class MqttConst {
    + host : String
    + port : int
    + username : String
    + password : String
    + tTelemetry()
    + tStatus()
    + tControl()
  }

  class ThresholdConst {
    + ppmMin : double
    + ppmMax : double
    + phMin : double
    + phMax : double
    + tempMin : double
    + tempMax : double
    + wlMin : double
    + wlMax : double
  }
}

' =================== RELATIONSHIPS ===================
' --- UI Relations ---
AuthGate --> AuthService
HomeScreen --> MqttVM
MonitorScreen --> MqttVM
MonitorScreen --> MonitorTelemetryProvider
HistoryScreen --> ApiService
NotificationScreen --> NotificationListNotifier
AddKitScreen --> ApiKitsService
SettingsScreen --> ApiService
ProfileScreen --> AuthService

' --- Provider Relations ---
MqttVM --> MqttService
MqttVM --> ApiService
NotificationListNotifier --> ApiService
NotificationListNotifier --> ThresholdConst

' --- Service Relations ---
MqttService --> MqttConst
MqttService --> Telemetry
MqttService --> DeviceStatus
ApiService --> Telemetry
ApiKitsService --> Kit
AuthService ..> FirebaseAuth

@enduml



