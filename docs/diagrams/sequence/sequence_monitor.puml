@startuml
scale 6
skinparam monochrome true
title Sequence Diagram - Monitor

actor "User" as User
participant "Monitor Screen" as Form
participant "MqttVM" as MQTT
participant "MQTT Broker" as Broker
participant "ApiService" as API
participant "Backend REST API" as Backend

' === Awal ===
User -> Form : Membuka halaman monitor
activate Form
Form -> User : Menampilkan tampilan awal (loading)

' === Inisialisasi MQTT ===
Form -> MQTT : init()
activate MQTT
MQTT -> Broker : connect()
activate Broker
Broker --> MQTT : Connected
MQTT -> Broker : subscribe("kit/+/telemetry")
MQTT -> Broker : subscribe("kit/+/status")
deactivate Broker
deactivate MQTT

' === Load auto mode state ===
Form -> MQTT : loadAutoModeFromBackend(kitId)
activate MQTT
MQTT -> API : getDeviceMode(userId, kitId)
activate API
API -> Backend : GET /device/mode?userId={userId}&deviceId={kitId}
activate Backend
Backend --> API : {autoMode: true/false}
deactivate Backend
API --> MQTT : autoMode boolean
deactivate API
MQTT --> Form : Auto mode state
deactivate MQTT

' === Real-time telemetry stream ===
loop Setiap ada data baru
  Broker -> MQTT : Publish telemetry data
  activate MQTT
  MQTT -> MQTT : Parse JSON to Telemetry
  MQTT -> Form : notifyListeners()
  activate Form
  Form -> User : Update tampilan sensor (pH, PPM, Temp, dll)
  deactivate Form
  deactivate MQTT
end

' === User toggle auto/manual mode ===
User -> Form : Toggle mode Auto/Manual
activate Form
Form -> MQTT : setAutoMode(kitId, enabled)
activate MQTT
MQTT -> API : setDeviceMode(userId, kitId, autoMode)
activate API
API -> Backend : POST /device/mode
activate Backend
Backend --> API : Success
deactivate Backend
API --> MQTT : Success
deactivate API
MQTT --> Form : Mode updated
deactivate MQTT
Form -> User : Update tampilan mode
deactivate Form

' === User kontrol manual ===
alt Mode Manual
  User -> Form : Tekan tombol kontrol (pH Up, Nutrient, dll)
  activate Form
  
  Form -> API : POST /actuator/event?deviceId={kitId}
  activate API
  API -> Backend : POST /actuator/event
  activate Backend
  Backend --> API : Response with durations
  deactivate Backend
  API --> Form : Response with durations
  deactivate API
  
  Form -> MQTT : publishActuator(cmd, kitId, args)
  activate MQTT
  MQTT -> Broker : Publish ke "kit/{kitId}/control"
  activate Broker
  Broker --> MQTT : Published
  deactivate Broker
  deactivate MQTT
  
  Form -> User : Tampilkan feedback
  deactivate Form
end

@enduml
