@startuml
scale 3
skinparam monochrome true
title Sequence Diagram - Notification

actor "User" as User
participant "Notification Screen" as Form
participant "NotificationListNotifier" as Notifier
participant "ApiService" as API
participant "Backend REST API" as Backend
participant "MqttVM" as MQTT
participant "ThresholdConst" as Const

' === Background: Proses generate notifikasi ===
note over MQTT, Notifier: Proses ini berjalan di background setiap 30 detik

' === Cek mode dan evaluasi ===
Notifier -> API : getDeviceMode(userId, kitId)
activate API
API -> Backend : GET /device/mode?userId={userId}&deviceId={kitId}
Backend --> API : {autoMode: true/false}
deactivate API

Notifier -> API : getLatestTelemetry(kitId)
activate API
API -> Backend : GET /telemetry/latest?deviceId={kitId}
Backend --> API : Telemetry JSON
deactivate API

Notifier -> Const : Baca threshold (pH, PPM, Temp, WL)
Const --> Notifier : Threshold values

Notifier -> Notifier : Bandingkan telemetry dengan threshold
Notifier -> Notifier : Hitung deviation percentage

alt Auto Mode = true
  note over Notifier: Backend yang buat notifikasi via actuator.py
  Notifier -> Notifier : SKIP local notification
  Notifier -> API : getNotifications(userId) untuk refresh
  API -> Backend : GET /notifications
  Backend --> API : List<Notification> dari backend
else Manual Mode = false
  note over Notifier: Frontend yang buat notifikasi
  Notifier -> Notifier : Tentukan severity (urgent/warning)
  Notifier -> API : createNotification(userId, kitId, level, message)
  activate API
  API -> Backend : POST /notifications
  Backend --> API : Notification created
  deactivate API
  Notifier -> Notifier : _emit() untuk local display
end

' === User membuka halaman notifikasi ===
User -> Form : Membuka halaman notifikasi
activate Form

Form -> Notifier : Load notifications
activate Notifier

Notifier -> API : getNotifications(userId, days=7, limit=100)
activate API
API -> Backend : GET /notifications?userId={userId}
Backend --> API : List<Notification> JSON
deactivate API

Notifier --> Form : List<NotificationItem>
deactivate Notifier

Form -> User : Menampilkan daftar notifikasi
deactivate Form

' === User filter notifikasi ===
User -> Form : Pilih filter (All / Warning / Urgent)
activate Form
Form -> Form : Filter list berdasarkan level
Form -> User : Tampilkan hasil filter
deactivate Form

' === User mark as read ===
User -> Form : Tap notifikasi
activate Form
Form -> Notifier : markRead(notificationId)
activate Notifier
Notifier -> API : markNotificationRead(id)
activate API
API -> Backend : PUT /notifications/{id}/read
Backend --> API : Updated
deactivate API
Notifier --> Form : Updated
deactivate Notifier
Form -> User : Update tampilan (notifikasi sudah dibaca)
deactivate Form

@enduml
